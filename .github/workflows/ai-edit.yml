name: AI Edit (Claude Code)

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "The user's edit request"
        required: true
        type: string
      model:
        description: "Claude model to use"
        required: false
        default: "claude-sonnet-4-5-20250929"
        type: string

jobs:
  ai-edit:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Scrape reference sites
        run: |
          mkdir -p reference
          # Extract URLs from the prompt
          URLS=$(echo "${{ github.event.inputs.prompt }}" | grep -oP 'https?://[^\s"'"'"'<>]+' || true)
          if [ -n "$URLS" ]; then
            for URL in $URLS; do
              DOMAIN=$(echo "$URL" | sed 's|https\?://||' | sed 's|/.*||')
              echo "Scraping $URL (domain: $DOMAIN)..."
              mkdir -p "reference/$DOMAIN"
              # Mirror the site: follow links within same domain, download images, CSS, JS
              wget --mirror --convert-links --adjust-extension --page-requisites \
                --no-parent --timeout=10 --tries=2 --wait=0.5 \
                --directory-prefix="reference" \
                --reject="*.zip,*.tar,*.gz,*.pdf,*.mp4,*.avi,*.mov" \
                --no-host-directories \
                -e robots=off \
                "$URL" 2>&1 | tail -5 || true
              echo "Done scraping $DOMAIN"
              echo "Files downloaded:"
              find "reference/" -type f | head -50
            done
            # Also dump raw HTML for each page for easy reading
            for URL in $URLS; do
              echo "---"
              echo "Fetching clean HTML: $URL"
              curl -sL "$URL" > "reference/main-page.html" 2>/dev/null || true
              # Try to find subpages from the main page
              SUBPAGES=$(curl -sL "$URL" | grep -oP 'href="(/[^"]*)"' | sed 's/href="//;s/"//' | sort -u | head -20)
              for SUB in $SUBPAGES; do
                SAFE_NAME=$(echo "$SUB" | tr '/' '_')
                echo "  Fetching subpage: $URL$SUB"
                curl -sL "$URL$SUB" > "reference/page$SAFE_NAME.html" 2>/dev/null || true
              done
            done
          fi
          echo "=== Reference files ==="
          find reference/ -type f 2>/dev/null | head -100 || echo "No reference files"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude --model "${{ github.event.inputs.model }}" --dangerously-skip-permissions --max-turns 30 -p "
          The user wants you to edit their website. Here is their request:

          ${{ github.event.inputs.prompt }}

          IMPORTANT INSTRUCTIONS:
          1. Read CLAUDE.md first for the site editing rules.

          2. If there is a reference/ directory, it contains a SCRAPED COPY of the user's
             existing site or reference site. READ EVERY HTML FILE in reference/ carefully.
             Extract ALL real content: text, headings, descriptions, addresses, phone numbers,
             apartment listings, team members, services, prices — EVERYTHING.

          3. For images: check reference/ for downloaded images. Copy any useful images to the
             site root (or an images/ folder). If images weren't downloaded, keep the original
             URLs from the source site as img src (hotlink them).

          4. If the user linked to an existing site to recreate:
             - You MUST reproduce ALL the content and functionality, not just the homepage
             - Check EVERY subpage HTML file in reference/
             - Include all navigation links, all sections, all data
             - If the site has listings (apartments, products, etc.) — include ALL of them
             - If links go to external sites, keep those as external links
             - Recreate the COMPLETE site, not a summary of it

          5. After making all changes, commit them with a descriptive message using git.
          "

      - name: Push changes
        run: |
          git config user.name "claude[bot]"
          git config user.email "noreply@anthropic.com"
          # Don't push the reference/ scrape folder
          echo "reference/" >> .gitignore
          git add -A
          git diff --staged --quiet || git commit -m "AI edit via SiteForge"
          git push
